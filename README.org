#+TITLE: keepbook
#+AUTHOR:
#+OPTIONS: toc:2

* Overview

Keepbook is a local-first personal finance toolkit focused on data ownership.

- Your data is stored in plain JSON/TOML/JSONL files.
- The on-disk format is human-readable and easy to inspect/edit with normal tools.
- The data directory is fully portable: copy it, back it up, version it, and keep it long-term without lock-in.

* Implementations

Keepbook currently has two implementations in this repository:

- Rust: =src/= (reference CLI and library).
- TypeScript: =ts/= (port of the library/CLI surface).

Project policy is to keep business logic and output shapes aligned between both implementations.
Current TypeScript CLI gaps (as of this README update):

- =sync prices= returns a not-implemented error.
- =sync symlinks= is currently a stub response.
- =market-data fetch= returns a not-implemented error.
- Synchronizer support is partial relative to Rust.

* CLI

The main Rust binary is =keepbook=. Commands emit JSON.

Top-level commands:

- =config=
- =add=
  - =connection=
  - =account=
- =remove=
  - =connection=
- =set=
  - =balance=
  - =transaction= (append-only transaction annotation patches)
- =import=
  - =schwab transactions=
- =list=
  - =connections=
  - =accounts=
  - =balances=
  - =transactions=
  - =price-sources=
  - =all=
- =sync=
  - =connection=
  - =all=
  - =prices [all|connection|account]= (interactive selector when scope is omitted)
  - =symlinks=
- =auth=
  - =schwab login=
  - =chase login=
- =market-data fetch=
- =portfolio snapshot|history|change-points=
- =spending=

Global options:

- =--config <path>=
- =--git-merge-master=
- =--skip-git-merge-master=

Examples:

#+BEGIN_SRC bash
# Show resolved config and data directory
keepbook config

# Create a manual connection and account
keepbook add connection "Manual"
keepbook add account --connection <connection-id> "Checking"

# Set a balance snapshot entry
keepbook set balance --account <account-id> --asset USD --amount 1234.56

# Add/clear transaction annotation fields
keepbook set transaction \
  --account <account-id> \
  --transaction <transaction-id> \
  --category "Dining" \
  --note "Team lunch"

# Sync transactions/balances from one source
keepbook sync connection <connection-id-or-name>

# Refresh latest prices for all accounts
keepbook sync prices all

# Portfolio valuation in EUR at a specific date
keepbook portfolio snapshot --currency EUR --date 2026-02-01

# Spending report
keepbook spending --period monthly --group-by category
#+END_SRC

* Configuration

Default config path resolution:

1. =./keepbook.toml= if present.
2. =~/.local/share/keepbook/keepbook.toml= (XDG data dir fallback).

When no config file exists, defaults are used and the intended config directory becomes =data_dir=.

Config fields:

#+BEGIN_SRC toml
# Optional; if relative, resolved against config directory
# data_dir = "./data"

reporting_currency = "USD"

[display]
# Optional; if set, values denominated in the reporting currency are rounded to
# this many decimal places in CLI output.
# currency_decimals = 2
#
# Optional UI-oriented display fields (canonical JSON numeric values are unchanged):
# currency_grouping = true
# currency_symbol = "$"
# currency_fixed_decimals = true

[refresh]
balance_staleness = "14d"
price_staleness = "24h"

[tray]
# Number of most-recent portfolio history rows shown in tray menu.
history_points = 8
# Spending lookback windows (in days) shown as "Last Nd" rows.
spending_windows_days = [7, 30, 90]

[spending]
# Ignore matching account IDs or names in default portfolio spending reports.
# ignore_accounts = ["Individual", "acct-123"]
# Ignore matching connection IDs or names in default portfolio spending reports.
# ignore_connections = ["Schwab", "conn-123"]
# Ignore accounts containing any matching account tag in default portfolio spending reports.
# ignore_tags = ["brokerage"]

[git]
auto_commit = false
auto_push = false
merge_master_before_command = false
#+END_SRC

* Storage Layout

Primary storage root is the resolved =data_dir=.

#+BEGIN_SRC text
data/
  connections/
    by-name/                      # symlinks to connection dirs
    {connection-id}/
      connection.toml             # human config
      connection.json             # machine state
      accounts/                   # symlinks to account dirs

  accounts/
    {account-id}/
      account.json
      account_config.toml         # optional
      balances.jsonl              # append-only BalanceSnapshot rows
      transactions.jsonl          # append-only Transaction rows
      transaction_annotations.jsonl

  # market data store (also under data_dir)
  assets/
    index.jsonl                   # AssetId -> Asset registry entries
  prices/
    {asset-id}/
      {year}.jsonl
  fx/
    {BASE}-{QUOTE}/
      {year}.jsonl

  # configured network sources
  price_sources/
    {source-name}/
      source.toml
#+END_SRC

Notes:

- Balances are stored as full snapshots (all holdings for an account at one timestamp).
- Transaction files are append-only; read path dedupes with last-write-wins by transaction id.
- Transaction annotations are append-only patches stored separately from raw transactions.
- Symlinks are rebuilt with =keepbook sync symlinks=.
- =account_config.toml= supports per-account overrides such as
  =balance_staleness=, =balance_backfill=, and =exclude_from_portfolio=.

* Price Sources

Configured in =price_sources/*/source.toml=. Source type controls required credentials and supported asset classes.

Implemented source types:

- Equities: =eodhd=, =twelve_data=, =alpha_vantage=, =marketstack=
- Crypto: =coingecko=, =cryptocompare=, =coincap=
- FX: =frankfurter=

* Development

- Rust tests: =cargo test=
- TypeScript tests: =cd ts && yarn test=
- TypeScript package manager: use =yarn= in =ts/=

Useful helper commands from =justfile=:

- =just kb -- --help=
- =just run-tray -- --help=

* Architecture

Rust modules:

- =src/storage= - storage trait + JSON file implementation.
- =src/sync= - synchronizer traits, orchestration, auth flows.
- =src/market_data= - store, source adapters, routers, service builder.
- =src/portfolio= - valuation, history, and change-point logic.
- =src/app/= - application command handlers/types.
- =src/main.rs= - CLI entrypoint.
- =src/bin/keepbook-sync-daemon.rs= - optional tray sync daemon.

TypeScript modules:

- =ts/src/app= - app-layer command handlers/types.
- =ts/src/storage= - storage trait + JSON file implementation.
- =ts/src/market-data= - market data store and services.
- =ts/src/portfolio= - valuation/history/change points.
- =ts/src/cli/main.ts= - CLI entrypoint.

A lightweight FFI crate exists at =crates/keepbook-ffi= for embedding use cases.

* Why "Keepbook"?

Keepbook is about keeping control of your own financial records.
The point is durable ownership: plain files, readable forever, portable anywhere.

* License

MIT OR Apache-2.0.
