#+TITLE: keepbook
#+AUTHOR:
#+OPTIONS: toc:2

* Overview

Keepbook is a local-first personal finance toolkit.

- Data is stored in plain JSON/TOML/JSONL files you own.
- The core is a Rust library and CLI.
- Sync adapters, market data sources, and portfolio valuation are pluggable.

* Current Status

This repository is no longer at the initial MVP design stage. Current implementation includes:

- Connection/account management via CLI.
- JSON file storage with append-only balance snapshots and transactions.
- Synchronizers for Chase, Schwab, Coinbase, and Plaid.
- Price/FX source routing with configurable providers.
- Portfolio snapshot/history/change-point valuation commands.
- Optional git auto-commit and auto-push after data-changing operations.

Not implemented yet:

- Annotation layer (categories/notes as first class stored overlays).
- Budgeting/reporting UI workflows.
- Stable public API for frontend integration (frontend work is experimental).

* CLI

The main binary is =keepbook=. Commands emit JSON.

Key command groups:

- =config=
- =add connection|account=
- =set balance=
- =list connections|accounts|balances|transactions|price-sources|all=
- =sync connection|all|prices|symlinks=
- =auth schwab login= / =auth chase login=
- =market-data fetch=
- =portfolio snapshot|history|change-points=

Examples:

#+BEGIN_SRC bash
# Show resolved config and data directory
keepbook config

# Create a manual connection and account
keepbook add connection "Manual"
keepbook add account --connection <connection-id> "Checking"

# Set a balance snapshot entry
keepbook set balance --account <account-id> --asset USD --amount 1234.56

# Sync transactions/balances from one source
keepbook sync connection <connection-id-or-name>

# Refresh latest prices only
keepbook sync prices all

# Portfolio valuation in EUR at a specific date
keepbook portfolio snapshot --currency EUR --date 2026-02-01
#+END_SRC

* Configuration

Default config path resolution:

1. =./keepbook.toml= if present.
2. =~/.local/share/keepbook/keepbook.toml= (XDG data dir fallback).

Config fields (currently used):

#+BEGIN_SRC toml
# Optional; if relative, resolved against config directory
# data_dir = "./data"

reporting_currency = "USD"

[display]
# Optional; if set, values denominated in the reporting currency are rounded to
# this many decimal places in CLI output.
# currency_decimals = 2
#
# Optional; UI-oriented currency display formatting (does not change canonical JSON numeric fields):
# currency_grouping = true          # enable thousands separators
# currency_symbol = "$"             # prefix symbol
# currency_fixed_decimals = true    # when currency_decimals is set, pad to exactly that many dp

[refresh]
balance_staleness = "14d"
price_staleness = "24h"

[git]
auto_commit = false
auto_push = false
#+END_SRC

* Storage Layout

Primary storage root is the resolved =data_dir=.

#+BEGIN_SRC text
data/
  connections/
    by-name/                      # symlinks to connection dirs
    {connection-id}/
      connection.toml             # human config
      connection.json             # machine state
      accounts/                   # symlinks to account dirs

  accounts/
    {account-id}/
      account.json
      account_config.toml         # optional
      balances.jsonl              # append-only BalanceSnapshot rows
      transactions.jsonl          # append-only Transaction rows

  # market data store (also under data_dir)
  assets/
    index.jsonl                   # AssetId -> Asset registry entries
  prices/
    {asset-id}/
      {year}.jsonl
  fx/
    {BASE}-{QUOTE}/
      {year}.jsonl

  # configured network sources
  price_sources/
    {source-name}/
      source.toml
#+END_SRC

Notes:

- Balances are stored as full snapshots (all holdings for an account at one timestamp).
- Transaction files are append-only; read-path logic provides a last-write-wins view by transaction id.
- Symlinks are rebuilt with =keepbook sync symlinks=.
- =account_config.toml= supports per-account overrides such as
  =balance_staleness=, =balance_backfill=, and =exclude_from_portfolio=.

* Price Sources

Configured in =price_sources/*/source.toml=. Source type controls required credentials and supported asset classes.

Implemented source types:

- Equities: =eodhd=, =twelve_data=, =alpha_vantage=, =marketstack=
- Crypto: =coingecko=, =cryptocompare=, =coincap=
- FX: =frankfurter=

* Architecture

Main modules:

- =src/storage= - storage trait + JSON file implementation.
- =src/sync= - synchronizer traits, orchestration, auth flows.
- =src/market_data= - store, source adapters, routers, service builder.
- =src/portfolio= - valuation, history, and change-point logic.
- =src/app.rs= - CLI command handlers.

A lightweight FFI crate exists at =crates/keepbook-ffi= for embedding use cases.

* Why "Keepbook"?

Bookkeeping, but you keep the books.

* License

TBD (likely MIT or Apache-2.0).
